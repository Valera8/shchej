<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
    <h1>Вход через Яндекс в файле PHP, использующем CURL с получением токена</h1>
        <p>Авторизация с помощью API паспорта Яндекса облегчает вход, авторизацию пользователям вашего сайта. Не требуется вводить логин, пароль, капчу при авторизации, и вообще не нужна регистрация на сайте. На текущей странице моего блога реализован этот механизм. Если вы уже авторизованы на Яндексе, то чтобы войти на сайт, например для написания комментария, потребуется только один клик по значку «Яндекс вход». Если не выполнен вход в аккаунт (учетную запись) Яндекса, то потребуется 3, 4 клика, в зависимости от количества аккаунтов в Яндексе.
        </p>
        <h2>Порядок входа</h2>
        <p>Если посетитель этого блога не авторизован на ресурсе поисковика Яши, то после клика по значку
            <a href="#oauth">входа</a>
             механизм получения доступа следующий:
        </p>
        <ul>
            <li>откроется страница passport.yandex.ru для выбора аккаунтов входа,</li>
            <li>после произведенного выбора появится окно для ввода пароля,</li>
            <li>остается ввести пароль аккаунта яндекса и нажать «войти».</li>
        </ul>
        <p>В случае наличия единственного аккаунта у поисковика Яши кликов на один шаг меньше, т.е. только 3. Такой порядок входа значительно уменьшает количество движений у юзера.
        </p>
        <p>Для начала получения этого сервиса на нужных страницах сайта устанавливается ссылка входа.
        </p>
        <div class="glowing">
            <a href="https://oauth.yandex.ru/authorize?response_type=code&amp;client_id=000de41cfc364b99a9a646567d4cb04d" target="_blank" class="glow"><span><img class="ya" src="/images/login_ya.svg" alt="Кнопка войти через Яндекс"></span></a>
        </div>
        <p>После клика она отправляет посетителя на OAuth-сервер и имеет следующий вид:
        </p>
        <p>&lt;a href=&quot;https://oauth.yandex&#8203;.ru/authorize?response_type=code&client_id=&lt;<i>ID_ПРИЛОЖЕНИЯ</i>&gt;&gt;&lt;/a&gt;
        </p>
        <p>Про &lt;<i>ID_ПРИЛОЖЕНИЯ</i>&gt; написано в этой статье ниже. Угловые скобки и то что внутри скобок необходимо заменить конкретным значением.
        </p>
        <h2>Реализация входа через Яндекс на этом блоге</h2>
        <p>На OAuth-сервере API паспорта использует протокол OAuth 2.0. Подробности в документации <i>yandex.ru/dev/oauth/doc/dg/concepts/about.html</i>. После пройденных шагов по регистрации сайта, получению доступов вернутся <!--noindex-->ID ПРИЛОЖЕНИЯ и ПАРОЛЬ ПРИЛОЖЕНИЯ<!--/noindex-->, которые и надо реализовать в скрипте для получения токена, а далее и защищенных данных пользователя.
        </p>
        <p>У меня это реализовано в файле <i>yandex.php</i>. Скрипт этого файла отправляется на OAuth-сервер Яндекса POST-запросом. Там он обрабатывается и этот же файл <i>yandex.php</i> примет результат обработки.
        </p>
        <div class="slide">
            <label for="slide3">
                Развернуть/свернуть код
            </label>
            <input type="checkbox" id="slide3"/>
            <pre class="content"><code>
                &lt;?php&nbsp;/*авторизация&nbsp;через&nbsp;Яндекс*/<br />
                if&nbsp;(!$_GET['code'])&nbsp;{exit('error&nbsp;code');}<br />
                session_start();<br />
                //Инициализируем&nbsp;сеанс<br />
                $curl&nbsp;=&nbsp;curl_init();<br />
                //Устанавливаем&nbsp;адрес&nbsp;для&nbsp;подключения<br />
                curl_setopt($curl,&nbsp;CURLOPT_URL,&nbsp;'https://oauth.yandex&#8203;.ru/token');<br />
                //Указываем,&nbsp;что&nbsp;мы&nbsp;будем&nbsp;вызывать&nbsp;методом&nbsp;POST<br />
                curl_setopt($curl,&nbsp;CURLOPT_POST,&nbsp;1);<br />
                //Передаем&nbsp;параметры&nbsp;методом&nbsp;POST<br />
                curl_setopt($curl,&nbsp;CURLOPT_POSTFIELDS,&nbsp;'grant_type=authorization_code&code='.$_GET['code'].'&client_id=&lt;ID_ПРИЛОЖЕНИЯ&gt;&client_secret==&lt;ПАРОЛЬ_ПРИЛОЖЕНИЯ&gt;');<br />
                //Говорим,&nbsp;что&nbsp;надо&nbsp;возвратить&nbsp;результат<br />
                curl_setopt($curl,&nbsp;CURLOPT_RETURNTRANSFER,&nbsp;true);<br />
                //Запрещаем&nbsp;проверку&nbsp;сертификата&nbsp;удаленного&nbsp;сервера<br />
                curl_setopt($curl,&nbsp;CURLOPT_SSL_VERIFYPEER,&nbsp;false);<br />
                //Декодируем&nbsp;строку&nbsp;JSON&nbsp;в&nbsp;переменную&nbsp;PHP<br />
                $token&nbsp;=&nbsp;json_decode(curl_exec($curl),&nbsp;true);<br />
                //Закрываем&nbsp;CURL-соединение<br />
                curl_close($curl);<br />
                //Получаем&nbsp;данные&nbsp;пользователя<br />
                $data&nbsp;=&nbsp;json_decode(file_get_contents('https://login.yandex&#8203;.ru/info?oauth_token='.$token['access_token']),&nbsp;true);<br />
                //Сохраняем&nbsp;их&nbsp;в&nbsp;сессию<br />
                $_SESSION[&quot;name_ya&quot;]&nbsp;=&nbsp;$data[&quot;real_name&quot;];<br />
                $_SESSION['login_ya']&nbsp;=&nbsp;$data[&quot;login&quot;];<br />
                $_SESSION['email_ya']&nbsp;=&nbsp;$data[&quot;emails&quot;][0];<br />
                $_SESSION[&quot;avatar_id&quot;]&nbsp;=&nbsp;$data[&quot;default_avatar_id&quot;];<br />
                $_SESSION[&quot;avatar_empty&quot;]&nbsp;=&nbsp;$data[&quot;is_avatar_empty&quot;];<br />
                //Редирект&nbsp;на&nbsp;последнюю&nbsp;страницу<br />
                if(isset($_GET['state']))<br />
                {<br />
                $link&nbsp;=&nbsp;'http://'&nbsp;.&nbsp;$_SESSION['ya']&nbsp;.&nbsp;'#newComment';<br />
                }<br />
                else&nbsp;$link&nbsp;=&nbsp;'http://'&nbsp;.&nbsp;$_SESSION['ya'];<br />
                <br />
                header(&quot;Location:&nbsp;$link&quot;);<br />
                exit();<br />
                ?&gt;
            </code></pre>
        </div>
        <p>Отправляем POST-запрос на адрес «oauth.yandex.ru» и получаем результат с помощью
        </p>
            <h3>Коротко о CURL</h3>
        <p>Расширение CURL (Client URL Library) обеспечивает широкие средства управления сетевыми операциями компактным способом. Позволяет взаимодействовать с серверами по различным протоколам с синтаксисом URL. Эта библиотека функций предоставляет возможность посылать запросы из PHP скрипта методами POST, GET, PUT.
        </p>
        <p>Начиная с версии v1803 операционной системы Windows 10, служебная программа уже установлена и настроена. Её наличие проверяется вводом команды “curl -help“ в командную строку. Если ошибок нет, то можно пользоваться curl-ом. Для того чтобы функции библиотеки CURL были доступны из PHP-скрипта, в конфигурационном файле php.ini необходимо подключить расширение php_curl.dll, сняв комментарий (точка с запятой ;) с директивы extension.
        </p>
            <h3>Подробное комментирование входа в файле yandex.php</h3>
        <p>OAuth-сервер Яши производит редирект на адрес Callback URI, указанный нами при регистрации сайта. В моем случае на файл  <i>yandex.php</i>. При этом к адресу добавляется параметр code (‘code’ - &lt;код_подтверждения&gt;). Наличие его проверяется в самом начале PHP скрипта <i>yandex.php</i>, а затем этот код (<i>$_GET['code']</i>) используется функцией для получения нашего токена.
        </p>
        <p>Начинаем новый сеанс cURL функцией <i>curl_init()</i>, возвращающей дескриптор <i>$curl</i>, который используется последующими функциями.
        </p>
        <p>Функция <i>curl_setopt()</i> позволяет задать параметры текущего соединения. Константа <i>CURLOPT_URL</i>, в качестве параметра функции, описывает URL, с которым будет производиться операция. Задаем полный адрес удаленного сервера, именно полный – с префиксом <i>https://</i>, так как расширение CURL работает с несколькими видами протоколов. Нашему скрипту необходимо выполнить POST-запрос на <i>https://oauth.yandex.ru/token</i>.
        </p>
        <p>Туда передаем параметры. Для этого в функции <i>curl_setopt()</i>  используется константа <i>CURLOPT_POSTFIELDS</i> (данные, передаваемые в HTTP POST-запросе). Её значение - <i>'grant_type=authorization_code&code='.$_GET['code'].'&client_id=&lt;ID_ПРИЛОЖЕНИЯ&gt;&client_secret=&lt; ПАРОЛЬ_ПРИЛОЖЕНИЯ&gt;'</i>.
        </p>
        <p>ID и ПАРОЛЬ ПРИЛОЖЕНИЯ – из зарегистрированного на OAuth-сервере нашего сайта. Их нам сгенерировал и затем предоставил Яша после регистрации сайта.
        </p>
        <p>Подобным образом устанавливаем параметры о том, что результат надо возвратить, у удаленного сервера сертификат не проверять.
        </p>
        <p>После установки всех необходимых параметров при помощи функции <i>curl_exec($curl)</i> выполняется запрос к удаленному серверу, и затем производим декодирование полученной JSON строки в переменную PHP <i>$token</i>.
        </p>
        <p>Ключ <i>[‘access_token’]</i> массива <i>$token</i> как раз и содержит значение нашего искомого OAuth-токен.
        </p>
        <p>Завершаем сеанс cURL функцией <i>curl_close()</i>.
        </p>

            <h3>Токен от Яндекса</h3>
        <p>Далее работаем со значением ключа <i>[‘access_token’]</i>. Это и есть токен, предоставляющий доступ к защищённым данным пользователя, который на нашем сайте выполнил вход для авторизации через Яндекс без необходимости передачи логина и пароля.
        </p>
        <p>OAuth-токен требуется указывать при выполнении запроса к API. Информация о пользователе, о приложении заложена в токене. Токен информирует, от какого приложения (в нашем случае – сайта), от какого пользователя выполняется запрос, разрешил ли пользователь этому сайту доступ к своим данным в Паспорте, имеет ли пользователь полномочия для обращения к этим материалам.
        </p>
        <p>Для каждого пользователя отправляется свой отдельный токен.
        </p>
        <p>Таким образом, для работы с API Паспорта нет необходимости отправлять пароль пользователя, достаточно отправить его OAuth-токен.
        </p>
        <p>Нельзя никому сообщать значение токена, или давать возможность его получения. С его помощью злоумышленник получает доступ к секретным материалам юзера.
        </p>
            <h3>Работа с данными</h3>
        <p>Теперь в переменную <i>$data</i>, используя ключ <i>[‘access_token’]</i> массива <i>$token</i>, возвращаем ассоциативный массив с материалами о пользователе.
        </p>
        <p>Потребуется обратиться к документации на странице <i>yandex.ru/dev/passport/doc/dg/reference/response.html</i>, чтобы расшифровать формат ответа и  выяснить, как  извлечь имя, логин, адрес почты, аватарку и т.п. пользователя.
        </p>
        <p>Требуемые для дальнейшей работы данные сохраняем в сессию. Эти данные потребуются для ввода в скрипты на страницах сайта.
        </p>
            <h3>Редирект на страницы блога</h3>
        <p>Прошу обратить внимание, что API позволяет в URL, указанный при регистрации приложения, как Callback URL, добавлять после символа # некоторые данные о токене. Именно на этот URL Яндекс.Oauth перенаправляет пользователя после обработки токена. После # можно добавить параметр <i>‘state’</i> со значением строки. Это значение в адресной строке возвращается без изменения. Я его (<i>$_GET['state']</i>) использую для
            <a href=/article.php?id=10#redir><strong>редиректа с помощью заголовка Location</strong></a>, перенаправляя посетителя блога на конкретное место страницы, откуда он произвел авторизацию через Яндекс. Это улучшает юзабилите настоящего блога. Осуществляется путем установки якоря.
        </p>
        <p>Ссылка редиректа содержит элемент указателя <i>$_SESSION['ya']</i>. Значение его необходимо записывать в сессию на страницах сайта следующим образом:
        </p>
        <pre class="content"><code>
            &lt;?php<br />
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session_start();<br />
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_SESSION['ya']&nbsp;=&nbsp;$_SERVER['HTTP_HOST']&nbsp;.&nbsp;$_SERVER['REQUEST_URI'];<br />
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?&gt;
        </code></pre>
        <p>Такой редирект работает надежно.
        </p>
            <h2>Итог</h2>
        <p>Вот и все. Скрипт авторизации через Яндекс небольшой, а комментарий получился обширный. Итог файла используется в методах классов, функциях настоящего блога, реализующих вход.
        </p>
        <p>Описанный способ авторизации предоставляет преимущества не только посетителям ресурса, но и облегчает работу разработчику как готовая и бесплатная технология.
        </p>

</body>
</html>