<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<h1>Как я развернул приложение Алиса с помощью Яндекс.Диалогов и Heroku</h1>
<p>Алиса – голосовой помощник поисковой системы Яндекс. Работает в операционных системах Android, iOS, также в Windows в браузере Яндекс.Браузер. Позволяет обойтись без поисковой строки и соответственно без клавиатуры, вопрос можно задать устно и спросить у Алисы голосом.</p>
<p>С <time datetime="2018-03-13">13 марта 2018 года</time> Яша расширил возможности платформы Али, открыв проект Яндекс.Диалоги.<p>
<blockquote>
    «Теперь любой желающий сможет обучить Алису новым навыкам и с её помощью привлечь пользователей к своим проектам».
    <cite><a href="https://yandex.ru/blog/webmaster/yandeks-otkryvaet-platformu-alisy-dlya-vsekh">Блог Яндекса для вебмастеров</a></cite>
</blockquote>
<h2>Навык для Алисы</h2>

<p>Принял решение натаскать Алису навыку заработка в интернете, тем самым привлечь внимание к своему проекту «DaWork.ru».</p>
<p>Что же понимается под термином «навык» в Я.Диалогах? Для пользователей, навык – режим работы Алисы, когда она передает вопрос пользователя на сервер и отвечает на него текстом, контентом, подготовленным и размещенным там разработчиком. Для разработчика – это веб-сервис, реагирующий на реплики пользователя.</p>
<h2>Развертывание веб-сервиса</h2>

<p>Когда начинал этот проект, Яндекс предлагал развертывание навыка производить с помощью сервиса Now <span class="main-text">(https://zeit.co/now)</span>. Для этого необходимо установить на компьютер приложение Now. Именно под это приложение заточена работа платформы Диалоги. Предпринял попытку это сделать, но потерпел неудачу. Оказывается, это приложение устанавливается только на 64-разрядную систему. У меня на компьютере и планшете стоит 32-разрядная операционная система Windows 10.</p>
<p>Сегодня проект Диалогов расширил настройки, предоставляется дополнительная возможность производить развертывания на платформах Microsoft Azure и Amazon Web Services. К сожалению, эти ресурсы были предоставлены, когда моя работа была почти закончена.</p>
<p>Чтобы не переустанавливать операционную систему и не менять железо на компьютере пришлось искать другую площадку, поддерживающую работу с 32-разрядной системой. Развернуть и разместить мой веб-сервис с программой диалога пользователя и Алисы не терпелось. Проект выполнил на языке PHP. Посмотреть моё приложение «Alice» с навыком для Алисы можно на
    <a href="https://github.com/Valera8/Alice" target="_blank">GitHub</a>.</p>
<h3>Heroku – для развертывания приложения</h3>

<p>Остановил выбор на облачном хостинге – <a href="/article.php?id=11">Heroku</a>. Большое преимущество данной платформы, кроме всего прочего, - Героку позволяет развернуть сервис бесплатно.</p>
<p>В отличие от достойного уровня обслуживания платформой Диалоги сервиса Now, Яндекс не имеет никаких настроек для работы с хостингом Героку. Мне пришлось приспосабливать Я.Диалоги к Героку самостоятельно. В Интернете, к сожалению, никакой информации про это не имелось. Делюсь алгоритмом действий по развертыванию приложения PHP.</p>
<h3>Начало использования Heroku</h3>

<p>Хероки очень любит сотрудничать с GitHub. Поэтому, желательно иметь аккаунт на веб-сервисе GitHub, а на компе систему контроля версий Git. Скачать можно на сайте <span class="main-text">git-scm.com/</span>. Но это вовсе не обязательно – можно готовое приложение для развертывания на Хероки, расположить на своем локальном компе.</p>
<p>Хорошо знающим английский язык, рекомендую начать использование облачного хостинга с изучения учебника на странице <span class="main-text">devcenter.heroku.com/articles/getting-started-with-php#introduction</span>. В учебнике пошагово даны инструкции по развертыванию проекта на PHP.</p>
<p>Прежде всего, надо оформить бесплатный аккаунт<!--noindex--> - <span class="main-text">https://signup.heroku.com/dc</span><!--/noindex-->.</p>
<p>Затем установить Composer - инструмент управления зависимостями с библиотеками в PHP - <span class="main-text">getcomposer.org/doc/00-intro.md</span>.</p>
<p>Обязательно требуется загрузить и установить интерфейс командной строки Heroku (CLI). Есть ссылка на странице <!--noindex--><span class="main-text">devcenter.heroku.com/articles/getting-started-with-php#set-up</span><!--/noindex-->. Командная строка CLI упрощает создание и управление приложениями Хероки. Это важная часть использования Heroku. С помощью этого терминала происходит общение программиста с Хероки.</p>
<h3>Подготовка приложения</h3>

<p>На удаленный репозиторий GitHub загружается проект, или на локальной машине создаётся папка с именем, например, как у меня - Alice. В эту папку положить файлы:</p>
<ul>
    <li>Файл с исходным кодом обработчика веб-сервиса. Этот код принимает уведомления от Яндекс.Диалогов и отдаёт ответы для ретрансляции Алисой. В моём случае – <span class="main-text">index.php</span>.</li>
    <li>Специальный файл <a href="article.php?id=11#procfile"><span class="main-text">Procfile</span></a>.</li>
    <li>Файл <a href="article.php?id=11#composer"><span class="main-text">composer.json</span></a>.</li>
</ul>
<p>Так как у меня <span class="main-text">composer.json</span> пустой, <span class="main-text">composer.lock</span> я не создавал.</p>
<p>Этих файлов в приложении PHP достаточно для простого диалога пользователя с Алисой.</p>
<h3>Развертывание навыка на Heroku</h3>

<p>Теперь подготовленный навык можно загрузить на облачный хостинг Heroku. Для развертывания применяется системная командная строка от имени администратора. В Windows 10 – Программы ->Служебные-Windows  -> Командная строка. При помощи интерфейса командной строки Heroku (CLI), который уже установлен на компьютере, происходит развертывание приложения на Хероки.</p>
<p>Последовательность действий по развертыванию навыка идентична описанию по <a href="article.php?id=11#installation">установке сайта</a>. После установки навыка <a href="article.php?id=7#rename">переименовал</a> рандомное название, выданное хостингом, на выразительное <span class="main-text">alice-yandex</span>.</p>
<p>После успешного развертывания в личном аккаунте хостинга доступен Журнал сборки:</p>
<div class="slide">
    <label for="slide1">
        Развернуть/свернуть код
    </label>
    <input type="checkbox" id="slide1">
        <pre class="content"><code class="hljs xml">
-----> PHP app detected<!--noindex-->
-----> Bootstrapping...
-----> Installing platform packages...
NOTICE: No runtime required in composer.lock; using PHP ^5.5.17
- nginx (1.8.1)
- php (5.6.36)
- apache (2.4.33)
-----> Installing dependencies...
Composer version 1.6.4 2018-04-13 12:04:24
-----> Preparing runtime environment...
-----> Checking for additional extensions to install...
-----> Discovering process types
Procfile declares types -> web
-----> Compressing...
Done: 13.8M<!--/noindex-->
-----> Launching...
Released v9
https://alice-yandex.herokuapp.com/ deployed to Heroku
        </code></pre>
</div>

<p>Для регистрации в Яндекс.Диалоге в качестве Webhook URL взял этот адрес: <span class="main-text">https://alice-yandex.herokuapp.com/</span></p>
<h2>Webhook URL хостинга Heroku</h2>

<p>Webhook-ом в веб-разработке является способ реагирования или изменения поведения веб-страницы с помощью пользовательских обратных вызовов. Это пользовательские HTTP обратные вызовы. Когда происходит событие, вебхук спрашивает адрес этого сайта и отдает в теле POST запроса параметры.</p>
<p>Хостинг Heroku имеет сервис для вебхук – можно создать веб-сайт на Хероки и подписаться на уведомления о каждом развертывании приложения Хероки. Приложение Webhooks Viewer предоставляет такую возможность. Но это вовсе не то, что требуется для Яндекс.Диалогов.</p>
<p>При регистрации навыка в Яндекс.Диалогах у меня в многочисленных попытках возникала ошибка: «Ошибка в ответе Webhook».</p>
<figure class="col-xs-12">
    <img src=" images/webhook.gif" class="img-responsive" alt="Webhook URL*: Ошибка в ответе Webhook.">
    <figcaption>Рис. Ошибка в ответе Webhook</figcaption>
</figure>
<p>До конца так и не понял механизм работы этого сервиса. Благодарен <span class="main-text">Roman Paradeev</span>, что решил мою проблему с вебхук и
    <a href="https://github.com/Valera8/Alice/pull/1" target="_blank">починил его</a>.</p>
<h2>Приложение для Алисы на Heroku</h2>

<p>Когда приложение успешно сохранено в Я.Диалогах на вкладке Настройки, можно протестировать его и отправлять на модерацию. А после принятия модератором можно навык для Алисы, развернутый на Heroku, опубликовать. Самый трудный этап для меня оказался – пройти операцию сохранения.</p>
<p>Навык Алисы <a href="https://dialogs.yandex.ru/store/skills/664c1ca6-zarabotok-v-internete" target="_blank">«Заработок в интернете»</a> находится в Интернете.</p>
</body>
</html>